<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paritalk - Chat</title>
    <!-- Link to our custom styles.css -->
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Jitsi Meet External API - IMPORTANT: MUST be loaded as a regular script before module scripts use it -->
    <script src="https://meet.jit.si/external_api.js"></script>
</head>
<body>
    <div id="app-container">
        <!-- Chat Screen -->
        <div id="chat-screen">
            <!-- Chat Header -->
            <div class="flex flex-col items-start">
                <h2 id="current-room-display">Room: <span id="room-name"></span></h2>
                <span id="online-users-count" class="text-sm text-white opacity-80 mt-1">Online: 0</span>
            </div>
            <div class="flex flex-col items-end">
              <div class="flex items-center gap-2">
                <button id="video-call-button" title="Start Video Call" class="p-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-200">
                    <i class="fa-solid fa-video"></i>
                </button>
                <button id="leave-room-button" title="Leave Room" class="p-2 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors duration-200">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </button>
              </div>
            </div>
        </div>

        <!-- Message Area -->
        <div id="messages-container">
            <!-- Messages will be appended here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator">
            <span>.</span><span>.</span><span>.</span>
        </div>

        <!-- Message Input Area -->
        <div id="message-input-area">
            <input type="text" id="message-input" placeholder="Type a message...">
            <input type="file" id="image-upload" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation" class="hidden">
            <label for="image-upload" title="Attach File" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors duration-200 cursor-pointer">
                <i class="fa-solid fa-paperclip"></i>
            </label>
            <button id="send-button" class="p-2 rounded-full bg-green-500 text-white hover:bg-green-600 transition-colors duration-200">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Jitsi Video Call Container -->
    <div id="jitsi-container">
        <iframe id="jitsi-iframe" allow="camera; microphone; display-capture; autoplay"></iframe>
        <div id="jitsi-controls">
            <button id="hangup-button" class="hangup">
                <i class="fa-solid fa-phone-slash"></i> End Call
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message">Are you sure?</p>
            <button id="modal-confirm" class="confirm-button">Yes</button>
            <button id="modal-cancel" class="cancel-button">No</button>
        </div>
    </div>

    <!-- Emoji Picker (hidden by default) -->
    <div id="emoji-picker" class="absolute bg-white p-2 rounded-lg shadow-lg hidden" style="z-index: 50; top: 0; left: 0;">
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">ğŸ‘</span>
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">â¤ï¸</span>
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">ğŸ˜‚</span>
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">ğŸ˜­</span>
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">ğŸ˜¡</span>
        <span class="emoji-option cursor-pointer text-2xl p-1 hover:bg-blue-100 rounded-md">ğŸ¤”</span>
    </div>

</div>

<!-- Combined Firebase and Supabase JS -->
<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, remove, onDisconnect, serverTimestamp, runTransaction, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Supabase Client SDK Import
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- Firebase Configuration (YOUR ACTUAL CONFIG) ---
    const firebaseConfig = {
        apiKey: "AIzaSyA8Yj1Z1Mpv2lyt9SRxJ_w4U04BXt8hajk",
        authDomain: "paritalk.firebaseapp.com",
        databaseURL: "https://paritalk-default-rtdb.firebaseio.com",
        projectId: "paritalk",
        storageBucket: "paritalk.firebasestorage.app",
        messagingSenderId: "441945619664",
        appId: "1:441945619664:web:045e0c872e67e0eb9fb2d5"
    };
    const initialAuthToken = null; // Not used for GitHub Pages deployment.

    // Initialize Firebase
    let app;
    let auth;
    let db;

    try {
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId && firebaseConfig.databaseURL) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            console.log("Firebase initialized successfully in chat.html.");
        } else {
            console.error("Firebase configuration is missing or empty in chat.html.");
            window.location.href = `index.html?error=${encodeURIComponent('App configuration error: Firebase is not set up correctly for chat.')}`;
            throw new Error("Firebase config missing for chat page.");
        }
    } catch (error) {
        console.error("Error during Firebase initialization in chat.html:", error.message);
        window.location.href = `index.html?error=${encodeURIComponent('Initialization error in chat. Please try again.')}`;
        throw error;
    }


    // Supabase Configuration (Using your confirmed URL and provided Anon Key)
    const SUPABASE_URL = 'https://uokpkgybjzvpngoxasnm.supabase.co'; // CONFIRMED CORRECT URL (ends with .co)
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVva3BrZ3lianp2cG5nb3hhc25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5MjE4NTcsImV4cCI6MjA2NTQ5Nzg1N30.FNv_13S3oj7fjartmY2PzKL25T3AWbMxP2KRI0rFU2E';

    let supabase;
    try {
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("Supabase client initialized successfully with URL:", SUPABASE_URL); // Log the exact URL used
        } else {
            console.warn('Supabase URL or Anon Key not set. File uploads will not work. Please ensure keys are correctly set.');
            supabase = null;
        }
    } catch (error) {
        console.error('Failed to initialize Supabase:', error);
        supabase = null;
    }


    // Global variables for chat state
    let currentUserId = null;
    let currentUsername = '';
    let currentRoomCode = '';
    let roomRef = null;
    let presenceRef = null;
    let messagesRef = null;
    let typingRef = null;
    let jitsiApi = null;
    let typingTimeout = null;

    // UI Elements
    const chatScreen = document.getElementById('chat-screen');
    const roomNameDisplay = document.getElementById('room-name');
    const onlineUsersCountDisplay = document.getElementById('online-users-count');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const imageUploadInput = document.getElementById('image-upload');
    const videoCallButton = document.getElementById('video-call-button');
    const leaveRoomButton = document.getElementById('leave-room-button');
    const jitsiContainer = document.getElementById('jitsi-container');
    const jitsiIframe = document.getElementById('jitsi-iframe');
    const hangupButton = document.getElementById('hangup-button');
    const typingIndicator = document.getElementById('typing-indicator');

    // Emoji Picker elements
    const emojiPicker = document.getElementById('emoji-picker');
    let currentMessageElementForReaction = null;

    // Modal elements
    const confirmationModal = document.getElementById('confirmation-modal');
    const modalMessage = document.getElementById('modal-message');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    let resolveModalPromise;


    // --- Get Room Code and Username from URL ---
    const urlParams = new URLSearchParams(window.location.search);
    const urlRoomCode = urlParams.get('room');
    const urlUsername = urlParams.get('user');

    if (!urlRoomCode || !urlUsername) {
        console.error("Missing room code or username in URL. Redirecting to login.");
        window.location.href = 'index.html';
    } else {
        currentRoomCode = decodeURIComponent(urlRoomCode);
        currentUsername = decodeURIComponent(urlUsername);
        roomNameDisplay.textContent = currentRoomCode;

        chatScreen.classList.remove('hidden');

        localStorage.setItem('paritalk_username', currentUsername);
        localStorage.setItem('paritalk_roomcode', currentRoomCode);
    }


    // --- Authentication & Initialization ---
    if (auth && db) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated with Firebase. User ID:", currentUserId);
                roomRef = ref(db, `rooms/${currentRoomCode}`);
                presenceRef = ref(db, `rooms/<span class="math-inline">\{currentRoomCode\}/presence/</span>{currentUserId}`);
                messagesRef = ref(db, `rooms/${currentRoomCode}/messages`);
                typingRef = ref(db, `rooms/<span class="math-inline">\{currentRoomCode\}/typing/</span>{currentUserId}`);

                try {
                    await set(presenceRef, { username: currentUsername, lastSeen: serverTimestamp() });
                    onDisconnect(presenceRef).remove();
                    console.log("User presence set in Firebase.");

                    if (localStorage.getItem('paritalk_has_joined_session') !== currentRoomCode + currentUsername) {
                        sendMessage(`**${currentUsername}** joined the chat.`, 'system');
                        localStorage.setItem('paritalk_has_joined_session', currentRoomCode + currentUsername);
                    }

                    listenForMessages();
                    listenForPresence();
                    listenForTyping();
                    console.log("Firebase listeners started.");

                    messageInput.focus();

                } catch (error) {
                    console.error("Error setting up chat (presence/listeners):", error);
                    localStorage.removeItem('paritalk_username');
                    localStorage.removeItem('paritalk_roomcode');
                    window.location.href = `index.html?error=${encodeURIComponent('Failed to set up chat. Please try again.')}`;
                }
            } else {
                console.warn("User not authenticated in chat.html. Redirecting to login.");
                window.location.href = 'index.html';
            }
        });
    } else {
        console.error("Firebase Auth or DB not initialized. Cannot set up onAuthStateChanged listener.");
        window.location.href = `index.html?error=${encodeURIComponent('Core app services not ready. Please try again.')}`;
    }


    // --- Helper Functions ---
    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
            return '';
        }
        const options = { hour: 'numeric', minute: 'numeric', hour12: true };
        return date.toLocaleTimeString('en-US', options);
    }

    function showModal(message) {
        modalMessage.textContent = message;
        confirmationModal.style.display = 'flex';
        return new Promise(resolve => {
            resolveModalPromise = resolve;
        });
    }

    function hideModal() {
        confirmationModal.style.display = 'none';
    }

    // --- Chat Logic ---
    function listenForMessages() {
        if (!messagesRef) {
            console.error("messagesRef is not initialized. Cannot listen for messages.");
            return;
        }
        onChildAdded(messagesRef, (snapshot) => {
            const message = snapshot.val();
            const messageId = snapshot.key;
            addMessageToChat(message, messageId);
        });
    }

    function addMessageToChat(message, messageId) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message-bubble', 'flex', 'flex-col', 'max-w-[75%]', 'p-2', 'rounded-xl', 'shadow-sm', 'relative');
        messageElement.dataset.messageId = messageId;

        let contentHTML = '';

        if (message.type === 'system') {
            messageElement.classList.add('system');
            contentHTML = message.text;
            messageElement.textContent = message.text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return;
        }

        const isMine = message.sender === currentUsername;
        messageElement.classList.add(isMine ? 'mine' : 'other');

        if (message.type === 'text') {
            contentHTML += `<p>${message.text}</p>`;
        } else if (message.type === 'image') {
            contentHTML += `
                <img src="<span class="math-inline">\{message\.imageUrl\}" alt\="Shared Image"
