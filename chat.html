<script type="module">
    // ... (rest of your script) ...

    async function initializeJitsiInstance() {
        // Use a unique room name for Jitsi to avoid conflicts with locked rooms or lingering sessions
        // Using currentCallId for consistency with the system message
        const jitsiRoomName = currentCallId || `${currentRoomCode}-${Date.now()}`;
        console.log("Attempting to initialize Jitsi with room name:", jitsiRoomName);


        if (!window.JitsiMeetExternalAPI) {
            console.error('JitsiMeetExternalAPI not found. This should not happen if loadJitsiScript was successful.');
            alert('Jitsi video call service not ready. Please try again.');
            hangUpCall();
            return;
        }

        if (jitsiApi) {
            console.log("Jitsi API already initialized. Disposing existing instance.");
            jitsiApi.dispose();
            jitsiApi = null;
        }

        jitsiContainer.classList.remove('hidden');
        jitsiContainer.style.display = 'flex'; // Ensure it becomes visible as flex container

        const domain = 'meet.jit.si';
        const options = {
            roomName: jitsiRoomName, // Use the unique Jitsi room name
            width: '100%',
            height: '100%',
            parentNode: document.querySelector('#jitsi-meet-api'),
            userInfo: {
                displayName: currentUsername
            },
            configOverwrite: {
                startWithAudioMuted: false,
                startWithVideoMuted: false,
                disableSelfView: false,
                enableClosePage: false,
                prejoinPageEnabled: false, // Explicitly disable prejoin page (lobby)
                enableWelcomePage: false,
                startSilent: false,
                toolbarButtons: [
                    'microphone', 'camera', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat',
                    'settings', 'tileview', 'toggle-raise-hand',
                    'videoquality', 'filmstrip',
                ],
                // Add these to explicitly disable authentication features if they are being inadvertently enabled
                requireDisplayName: false, // Ensure display name is not strictly required for authentication
                enableUserRolesBasedOnToken: false, // Do not try to assign roles based on a token we aren't providing
                enableLobby: false, // Explicitly disable the lobby feature
                // disablePrivateChat: true, // Optional: if you want to disable private chat in Jitsi
                // disablePolls: true, // Optional: if you want to disable polls in Jitsi
            },
            interfaceConfigOverwrite: {
                APP_NAME: 'Paritalk',
                DEFAULT_BACKGROUND: '#F9F9F9',
                NATIVE_APP_NAME: 'Paritalk',
                TOOLBAR_BUTTONS: [
                    'microphone', 'camera', 'desktop', 'fullscreen',
                    'fodeviceselection', 'hangup', 'profile', 'chat',
                    'settings', 'tileview', 'toggle-raise-hand',
                    'videoquality', 'filmstrip',
                ]
            }
        };

        try {
            jitsiApi = new JitsiMeetExternalAPI(domain, options);

            jitsiApi.addEventListener('iframe-ready', () => {
                console.log("Jitsi iFrame is ready.");
            });
            jitsiApi.addEventListener('participantJoined', (participant) => {
                console.log("Jitsi: Participant joined:", participant);
            });

            jitsiApi.addEventListener('readyToClose', () => {
                console.log("Jitsi: Ready to close event detected.");
                hangUpCall();
            });
            jitsiApi.addEventListener('videoConferenceLeft', () => {
                console.log("Jitsi: Video conference left.");
                hangUpCall();
            });
            jitsiApi.addEventListener('participantLeft', (participant) => {
                console.log("Jitsi: Participant left:", participant);
            });

            console.log("Jitsi API initialized and event listeners attached.");

        } catch (error) {
            console.error("Error initializing Jitsi API:", error);
            alert('Failed to start video call. Please check console for details.');
            hangUpCall();
        }
    }

    // ... (rest of your script) ...
</script>
